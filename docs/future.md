# 3dpmon 今後の拡張計画

このドキュメントでは、複数接続ダッシュボード拡張に向けた要件定義の概要をまとめます。

## 0. 改版履歴

| revision | 日付 | 主な変更点 |
| --- | --- | --- |
| 1 | 2025-06-27 | 複数接続構想 (タブ化・カード分離) 初版 |
| 2 | 2025-06-27 | `model` 分岐・監視カメラ特別仕様追加 |
| 3 | 2025-06-27 | 要件統合・既知課題列挙 |
| **4** | **2025-06-27** | 認証 UI・大量タブ UX・IP/hostname 方針・テスト/安定化策を追加 |

## 1. 目的とスコープ

| 区分 | 内容 |
| --- | --- |
| 目的 | 1 ブラウザで複数台の 3D プリンタをリアルタイム監視・操作する |
| 範囲 | **フロントエンド** (HTML/CSS/JS/ES6 Modules), **WebSocket/HTTP** 接続制御, **ローカル保存** (`localStorage`/`IndexedDB`) |
| 前提 | すべてローカル LAN 内動作。外部公開を前提としたセキュア通信は将来拡張で対応 |

## 2. 全体アーキテクチャ

```
┌──────────────────────────────┐
│  起動認証 (テンキー)           │  ← 認証完了まで他モジュールを Lazy Import
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│ ConnectionManager            │  登録 CRUD / WS 再接続 / 切断
│  └ 接続単位 DataStore        │  monitorData・storedData 分離保持
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│ DashboardManager             │  タブ生成・切替・レイアウト永続化
└──────────────────────────────┘
        │
        ▼
┌──────────────────────────────┐
│ Cards (parts/*.js)           │  印刷状態 / 温度 / フィラメント / カメラ …
│  └ UI Utilities              │  ドラッグ・トースト etc.
└──────────────────────────────┘
```

## 3. 機能要件

### 3.1 起動認証

- 通常はOFFだが、F5キーを押したり再起動したときに簡易ロックがかかる機能を実装する
- ON/OFF は通信設定メニューから切り替え可能

| 項目 | 要件 |
| --- | --- |
| 方式 | 数値 4–8 桁テンキー入力 |
| UI | 全画面モーダル＋アニメ付きフィードバック |
| 保存 | 入力値を `localStorage` に **SHA-256 + Salt** で保持 |
| セキュリティ | 認証完了まではアプリ本体コードをロードしない (Lazy Import) |

### 3.2 接続設定 UI

| フィールド | 入力種別 | 備考 |
| --- | --- | --- |
| IP (必須) | Text | 接続キー |
| WSポート | Radio `9999` / 任意 | |
| カメラポート | Radio `8080`,`8000`/任意 | |
| カメラポート | Radio http / https | 現時点では http 使用 |
| ファイル転送 | Radio `80`/任意 | |
| ファイル転送 | Radio http / https | 現時点では http 使用 |
| Hostname | Label (自動) | 接続成功時取得 |
| Model | Label (自動) | JSON `model` キー |
| 色 | Color picker (14 色 + HEX) | 通知・タブ色に反映 |
| アイコン | SVG 20 種 | 機種別 or 任意 |

### 3.3 接続ロジック

1. 一次キー：`connectionId = sha1(IP:WSport)`
2. 接続成功後 `hostname` を取得し、同一 `hostname` & `model` なら同一プリンタ判定
3. `hostname` 一致でも `model` が異なる場合は別プリンタとして新タブを生成し、重複警告バッジを表示

### 3.4 タブ式ダッシュボード

| 機能 | 詳細 |
| --- | --- |
| タブバー | タイトルバー直下／ユーザー定義名表示 |
| スクロール | タブ 8 枚超で水平スクロール＋フェードインディケータ |
| ドロップダウン | 接続一覧を表示するコンボボックス |
| ショートカット | `Alt + Wheel` で水平スクロール |

### 3.5 カード共通仕様

| 要素 | 設計 |
| --- | --- |
| 右上ボタン | **≡**（メニュー／ドラッグ用ハンドル） + **✕**（閉じる） |
| 倍率 | 0.5–2.0 倍 `transform: scale()` |
| 並べ替え | `data-card-id` を付与し **Sortable.js** 互換 |

### 3.6 監視カメラカード（特別）

| 項目 | 要件 |
| --- | --- |
| 最小サイズ | 160×120 px (設定可)、アスペクト 3:4 想定 (設定可) |
| アスペクト比 | `aspect-ratio` / `object-fit:contain` |
| 再接続 | `error` または `stalled` 検知 3 回失敗で静止サムネへ切替 |

### 3.7 モデル依存 UI

| model | 追加 UI / 変更点 |
| --- | --- |
| K1 MAX | 300x300x300mm ステージ・大型プリントプレビュー |
| K1C | 220x220x250mm ステージ・標準 |
| K1 | 220x220x250mm ステージ・標準 |
| K1 SE | 220x220x250mm ステージ・標準 |
| CR-30 | Y方向無限ベルト対応 |
| その他 | 汎用 |

`ModelAdapter` クラスで `getCustomCards()` と `patchCardConfig()` を提供予定。

### 3.8 通知識別

- トースト・WebPush に接続色とアイコン、タブ名を表示
- フォーマット例：`[🚀K1-MAX] 印刷完了 – Benchy.gcode`

## 4. 非機能要件

| 区分 | 要件 |
| --- | --- |
| パフォーマンス | 5 台・360p カメラ同時表示で CPU ≤ 50 % (Core i5 + Chrome) |
| レスポンシブ | 1024×768 以上で横 2 列～3 列カード表示、モバイルは iPhone に対応 |
| アクセシビリティ | タブ・モーダルに WAI-ARIA / キーボードナビ |
| 国際化 | `i18n/ja.json` `i18n/en.json` でラベル外部化を検討 |
| 安定性 | ResourceWatch：30 秒ごとに RAM/DOM/WS 状態チェック。WS zombie 検知 (ping/pong) で再接続 |
| セキュリティ | ローカル運用前提。TLS/トークン認証は拡張ポイントを確保 |

## 5. テスト・品質保証

現在は文法チェックとオブジェクト宣言チェックのみ。より具体的なテストを検討中。

### 5.1 自動テスト基盤

| レイヤ | ツール | 内容 |
| --- | --- | --- |
| 単体 | Vitest / Jest | Utility・ModelAdapter テスト |
| 結合 | Node.js 仮想プリンタ (`ws`) | JSON シナリオ送信 |
| E2E | Playwright + headless Chrome | タブ生成・カード移動・再接続ループ |
| CI | GitHub Actions | Linux + Chrome 最新で nightly 実行 |

### 5.2 メトリクス

- ユースケース 50 シナリオ合計成功率 ≥ 98 %
- メモリリーク検証：4 時間連続稼働で増加 ≤ 5 %

---

[← README](../README.md)

